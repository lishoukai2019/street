<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dao.ShopCommentDao">
	<select id="queryShopCommentList" resultMap="shopCommentMap">
		SELECT
		user_name,shop_name,shop_comment_id,tb_shop_comment.shop_id,order_id,tb_shop_comment.user_id,comment_content,service_rating,star_rating,comment_reply
		FROM tb_shop_comment
		LEFT JOIN tb_shop
		ON tb_shop_comment.shop_id=tb_shop.shop_id
		LEFT JOIN tb_person_info
		ON tb_shop_comment.user_id=tb_person_info.user_id
		<where>
			<if test="shopCommentCondition.userName != null">
				and user_name = #{shopCommentCondition.userName}
			</if>
			<if test="shopCommentCondition.shopName != null">
				and shop_name = #{shopCommentCondition.shopName}
			</if>
			<if test="shopCommentCondition.shopId != null">
				and tb_shop_comment.shop_id = #{shopCommentCondition.shopId}
			</if> 
		<if test="shopCommentCondition.orderId != null">
				and order_id = #{shopCommentCondition.orderId}
			</if>
			<if test="shopCommentCondition.userId != null">
				and tb_shop_comment.user_id = #{shopCommentCondition.userId }
			</if>
			<if
				test="shopCommentCondition.commentContent != null">
				and comment_content like '%${shopCommentCondition.commentContent}%'
			</if> 
			<if
				test="shopCommentCondition.commentReply != null">
				and comment_reply like '%${shopCommentCondition.commentReply}%'
			</if>
		</where>
		<if test="sort != null and order != null">
			ORDER BY ${sort} ${order}
		</if>
		<if test="sort == null and order == null">
			ORDER BY shop_comment_id desc
		</if>
		LIMIT #{rowIndex},#{pageSize};
	</select>

	<select id="queryShopCommentList2" resultMap="shopCommentMap">
		SELECT
		shop_comment_id,shop_id,tb_shop_comment.order_id,tb_shop_comment.user_id,comment_content,service_rating,star_rating,comment_reply
		FROM
		tb_shop_comment
		LEFT OUTER JOIN  tb_order  USING(order_id)
		<where>
			<if test="shopCommentCondition.userId != null">
				and tb_shop_comment.user_id = #{shopCommentCondition.userId }

			</if>
			<if
				test="shopCommentCondition.shopId != null">
				and shop_id = #{shopCommentCondition.shopId}
			</if> 
			<if
				test="shopCommentCondition.commentContent != null">
				and comment_content like '%${shopCommentCondition.commentContent}%'
			</if> 
			<if
				test="shopCommentCondition.commentReply != null">
				and comment_reply like '%${shopCommentCondition.commentReply}%'
			</if>
            and is_delete = 0
		</where>
	</select>

	<select id="queryAvgStarRating" resultType="float">
		SELECT
		AVG(star_rating) as star_avg
		FROM
		tb_shop_comment
		where shop_id=#{shopId}
	</select>
		<select id="queryAvgServiceRating" resultType="float">
		SELECT
		AVG(service_rating) as service_avg
		FROM
		tb_shop_comment
		where shop_id=#{shopId}
	</select>
	<insert id="insertShopComment" parameterType="com.entity.ShopComment"
		useGeneratedKeys="true" keyProperty="shopCommentId" keyColumn="shop_comment_id">
		INSERT
		INTO
		tb_shop_comment(shop_id,order_id,user_id,comment_content,service_rating,star_rating,comment_reply)
		VALUES
		(#{shopId},#{orderId},#{userId},#{commentContent},
		#{serviceRating},#{starRating},#{commentReply})
	</insert>
	
	<update id="updateShopComment" parameterType="com.entity.ShopComment">
		update tb_shop_comment
		<set>
            <if test="shopId != null">shop_id=#{shopId},</if>
            <if test="orderId != null">order_id=#{orderId},</if>
			<if test="userId != null">user_id=#{userId},</if>
			<if test="commentContent != null">comment_content=#{commentContent},</if>
			<if test="serviceRating != null">service_rating=#{serviceRating},</if>
			<if test="starRating!=null">star_rating=#{starRating},</if>	
			<if test="commentReply != null">comment_reply=#{commentReply}</if>
		</set>
		where shop_comment_id=#{shopCommentId}
	</update>

	<delete id="deleteShopComment">
        delete from tb_shop_comment where shop_comment_id=#{shopCommentId}
    </delete>

	<select id="queryByShopCommentId" resultMap="shopCommentMap" parameterType="Long">
		SELECT
		shop_id,order_id,user_id,comment_content,service_rating,star_rating,comment_reply
		FROM
		tb_shop_comment
		WHERE
		shop_comment_id=#{shopCommentId}
	</select>
	<select id="queryByOrderId" resultMap="shopCommentMap" parameterType="Long">
		SELECT
		shop_comment_id,shop_id,order_id,user_id,comment_content,service_rating,star_rating,comment_reply
		FROM
		tb_shop_comment
		WHERE
		order_id=#{orderId}
	</select>

	<resultMap id="shopCommentMap" type="com.entity.ShopComment">
		<id property="shopCommentId" column="shop_comment_id"/>
		<result property="shopId" column="shop_id"/>
		<result property="orderId" column="order_id"/>
		<result property="userId" column="user_id"/>
		<result property="commentContent" column="comment_content"/>
		<result property="serviceRating" column="service_rating"/>
		<result property="startRating" column="start_rating"/>
		<result property="comment_reply" column="comment_reply"/>
	</resultMap>
</mapper>